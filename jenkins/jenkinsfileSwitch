pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['deploy-green', 'switch-blue', 'switch-green'],
            description: 'Select deployment or traffic action'
        )
    }

    stages {

        stage('Build Docker Image') {
            when {
                expression { params.ACTION == 'deploy-green' }
            }
            steps {
                sh 'docker build -t myapp:latest /home/rahil/blue-green-project/app'
            }
        }

        stage('Deploy Green') {
            when {
                expression { params.ACTION == 'deploy-green' }
            }
            steps {
                sh 'docker stop green || true'
                sh 'docker rm green || true'
                sh 'docker run -d --name green -p 8082:3000 myapp:latest'
            }
        }

        stage('Switch Nginx Traffic') {
            when {
                anyOf {
                    expression { params.ACTION == 'switch-blue' }
                    expression { params.ACTION == 'switch-green' }
                }
            }
            steps {
                script {
                    if (params.ACTION == 'switch-blue') {
                        sh 'sudo cp /home/rahil/blue-green-project/nginx/blue.conf /etc/nginx/conf.d/blue-green.conf'
                    } else {
                        sh 'sudo cp /home/rahil/blue-green-project/nginx/green.conf /etc/nginx/conf.d/blue-green.conf'
                    }
                }
            }
        }

        stage('Reload Nginx') {
            when {
                anyOf {
                    expression { params.ACTION == 'switch-blue' }
                    expression { params.ACTION == 'switch-green' }
                }
            }
            steps {
                sh 'sudo systemctl reload nginx'
            }
        }
    }
}

